<% layout( '../admin-layout' ) -%>


<h2>Instance: <span id="instanceTitle" class="xeditable"><%= items.title %></span></h2>

<!-- Phases -->
<form id="instance-form">
<div class="phases">
<% if ( items.phases) { 
	phase_i = -1
%>
	<% items.phases.forEach(function( phase ){ 
		phase_i++
	%>
		<div class="phase">
			<h3 class="xeditable phase-title" id="phase-title_<%= phase_i %>" data-type="text" data-pk="1" data-url="" data-title="Phase Title">
				<%= phase.title %>
			</h3>
			<div class="row">
				<!-- Define time range -->
				<div class="col-md-6 admin-panel">
					<div class="row">
						<div class='col-sm-5'>
							<div class="input-group input-group-xs">
								<span class="input-group-addon" id="start_<%= phase_i %>">Start</span>
								<input type="text" class="datetimepicker form-control" id="datetimepicker_<%= phase_i %>" aria-describedby="Select date and time when Phase should start"  value="">
							</div>
						</div>
						<div class='col-sm-5'>
							<div class="input-group input-group-xs">
								<span class="input-group-addon" id="start_<%= phase_i %>">End</span>
								<input type="text" class="datetimepicker form-control" id="datetimepicker_<%= phase_i %>" aria-describedby="Select date and time when Phase should start"  value="">
							</div>
						</div>
					</div>
				
				</div>
				<!-- Select Groups -->
				<div class="col-md-6 admin-panel">
					<h4>Group formations</h4>
					<div id="group_<%= phase_i %>" class="phase-group-list"></div>
				</div>
			</div>	
		</div>	
	<% }) %>
<% } %>
</div>

<br><br><br>
<div class="buttons">
	<button type="submit" class="btn-default btn">save instance</button>  
	<a href="/admin/scripts/instances">cancel</a> 
	<a class="alert-btn" href="/admin/scripts/instances/destroy/<%= items._id %>" title="Delete this instance">delete</a>
</div>
</form>

<script>

/*
todo
- collected configured data
- save data to DB
- 
*/


// make it editable
$.fn.editable.defaults.mode = 'inline'; // popup

var data = JSON.parse('<%-JSON.stringify( items.phases )%>');

$(document).ready(function() {
	// make text editable inline
	$('.xeditable').editable({
		success: function(response, value) {
        alert($(this).attr('id') +'__'+value)   
   	}
	});
	
	$('.datetimepicker').datetimepicker();
	
	// load group formations
	$.each( data, function(i, phase){
		// list available videos
		$.get('/json/admin/groups/formations', function(data){ 
			$.each(data, function(j, val){
				$('#group_'+i).append( $('<label><input type="radio" aria-label="'+val.title+'"> '+val.title+'</label><br>' ) );
			});
		});
	});
	
	/*
		template : [ScriptTemplate],
		phases : [ 
			{ 
				start : Date,
				end: Date,
				seq : Number,
    		groupindex: Number,
    		groupformation: Number
			}
		],
		
		updated_at 	: { type: Date, default: Date.now },
	*/
	
	// save input
	$('#instance-form').submit(function( event ) {
		event.preventDefault();	
		// collect data from form
		var res = data;
		res.title = $('#instanceTitle').text();
		res.title = 'ready';
		
		
		$.each( data, function(i, phase){
			
		});
		// send it
		$.ajax({
			type: "POST",
			url: '/admin/scripts/instances/update',
			data: res,
			success: function(res){ 
				window.location.href = '/admin/scripts/instances';
			},
			error : function(e){
				console.log(JSON.stringify(e));
			}	
		});
	});
});


</script>

